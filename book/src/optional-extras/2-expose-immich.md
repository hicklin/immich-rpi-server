# Expose Immich to the internet

This chapter describes how to securely expose immich to the internet. This specific setup addresses two main issues with the remote tailscale solution:
1. Sharing photos through share links
2. Accessing immich without tailscale VPN; required to work with privacy VPNs when VPNs can't run concurrently, such as on smart phones.

To enable these two features securely, we setup a reverse proxy to:
1. Allow public access to a limit set of APIs enabling photo sharing.
2. Only allow full server access to devices with valid mTLS certificates.

> [!CAUTION]
> Media shared through the share link can be accessed by anyone. Make sure to protect these share links with passwords when generated. You can manage shared links in Sharing > Shared links.

> [!IMPORTANT]
> Exposing immich to the internet inherently adds risk as it introduces an attack surface reachable by anyone. This solution introduces as number of measures to mitigate these risks. If you choose to deviate from this tutorial, it's important to understand how these measures work together to enable secure modifications.

## The architecture

- Tailscale funnel: Public URL for immich
- Caddy: reverse proxy with filters and rate limiting
- fail2ban: ban multiple login attempts

## Setup

### 1. Server certificate

A server certificate allows secure HTTPS communication. We will use Let's Encrypt server certificates generated by tailscale to avoid browser warnings caused by self-signed certs.

 1. Enable Let's Encrypt certificate generation in tailscale: Dashboard > DNS > HTTPS Certificates > Enable HTTPS.
 2. Download the certs from tailscale:
  ```bash
  sudo tailscale cert --cert-file /var/lib/caddy/cert.pem --key-file /var/lib/caddy/key.pem $(tailscale status --json | jq -r '.Self.DNSName' | sed 's/\.$//')
  ```
 3. ```
 sudo chown caddy:caddy /var/lib/caddy/cert.pem /var/lib/caddy/key.pem```

### 2. Create a Certificate Authority (CA)

`sudo install -d -m 755 -o admin -g users /val/lib/immich-certs`

Create a certificate authority on the immich server that will generate mTLS certificates for trusted devices.

1. `cd /val/lib/caddy`?? This will not exist before config change. Maybe we should choose a different location.
2. Generate a private CA key: `openssl genrsa -out ca-key.pem 4096`.
3. Generate a self-signed CA certificate: `openssl req -new -x509 -days 3650 -key ca-key.pem -out ca-cert.pem -subj "/CN=Immich Client CA/O=Personal/C=US"`

### 3. Generate Client Certificates

We need to generate client certificates for devices that we trust to have full access to our server such as a personal computer or phone.

1. `export CLIENT="<client-name>"
2. Generate client private key:
  ```
  openssl genrsa -out $CLIENT.key 4096
  ```
3. Create a certificate signing request (CSR):
  ```
  openssl req -new -key $CLIENT.key -out $CLIENT.csr -subj "/CN=$CLIENT/O=MyOrg"
  ```
4. Sign the CSR with the CA:
  ```
  openssl x509 -req -in $CLIENT.csr
  -CA ca.crt -CAkey ca.key \
  -CAcreateserial -out $CLIENT.crt \
  -days 3650 -sha256
  ```
5. If the client is a phone, generate a PKCS#12 bundle. You'll be prompted to set a password, remember it for installation.
  ```
  openssl pkcs12 -export \
  -out $CLIENT.p12 \
  -inkey $CLIENT.key \
  -in $CLIENT.crt \
  -certfile ca.crt \
  -name "$CLIENT Cert"
  ```
6. chmod 600 *.pem *.p12?

### 4. Install mTLS certs on your devices

Phones will only required `.p12` certs. Computers typically required the `$CLIENT.crt`, `$CLIENT.key` and `ca.crt`. Search how to install mTLS certificate on your specific device / OS.

### 5. Update configuration

The reverse proxy, caddy, it's filters and fail2ban described in the Architecture section are all preconfigured in the `expose-immich.nix` configuration file. To enable it, in `configuration.nix` `imports` section, comment out `./lan-immich.nix` and comment in `./expose-immich.nix`.

### 6. Open sever to the internet

Now that we have server certificates for secure https communication with the server, client certificates for allowed devices and a reverse proxy only allowing share API access, we can expose the server to the internet. This is done using tailscale funnel. This is a feature provided by tailscale that exposes the tailscale url to the internet and forwards requests to a specific port.

```
sudo tailscale funnel --bg $(tailscale status --json | jq -r '.Self.DNSName' | sed 's/\.$//'):8443
```

To stop the funnel, removing the public endpoint, use

```
sudo tailscale funnel reset
```


Forbidden `"status":403` when accessing without TLS cert
