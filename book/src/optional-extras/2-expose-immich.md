# Expose Immich to the internet

This chapter describes how to securely expose immich to the internet. This specific setup addresses two main issues with the main tailscale VPN solution:
1. Sharing photos through share links with devices not on the tailscale network.
2. Accessing immich without tailscale VPN; required to work with privacy VPNs on devices limited to one VPN instance, such as Android phones.

To enable these two features securely, we setup a reverse proxy to:
1. Grant public access to a limit set of APIs required for photo sharing.
2. Grant full server access only to devices with valid mTLS certificates.

> [!CAUTION]
> Media shared through a share link can be accessed by anyone. Make sure to protect these share links with passwords when generated. You can manage shared links in Sharing > Shared links.

> [!IMPORTANT]
> Exposing immich to the internet inherently adds risk. This solution introduces as number of measures to mitigate these risks. If you choose to deviate from this setup, it's important to understand how these measures work together to enable secure modifications.

## The architecture

![public-immich-access](../assets/public-immich-access.png)

### Glossary

- **Tailscale funnel**: A tailscale service that exposes the device URL to the public internet and forwards HTTPS requests to the device.
- **Caddy**: A reverse proxy service, filtering requests to the server.
- **Fail2ban**: Banning service. Bans abusive IPs.
- **mTLS**: Mutual TLS, enables mutual authentication between a client and a server.

## Setup

### 1. Enabled nix configuration

The reverse proxy, caddy, it's filters and fail2ban described above are all preconfigured in the `expose-immich.nix` configuration file. To enable it, in `configuration.nix` `imports` section, comment out `./lan-immich.nix` and comment in `./expose-immich.nix`. Follow this with `sudo nixos-rebuild switch`

> [!NOTE]
> You may notice errors for some of the newly added services. This is expected until we finish the following one-time setup steps.

### 2. Server certificate

A server certificate allows secure HTTPS communication. We will use Let's Encrypt server certificates generated by tailscale to avoid browser warnings caused by self-signed certs.

1. Enable Let's Encrypt certificate generation in tailscale: Dashboard > DNS > HTTPS Certificates > Enable HTTPS.
2. Create certificates directory:
   ```bash
   sudo install -d -m 755 -o $USER -g users $IMMICH_CERTS_DIR
   ```
3. Download the certs from tailscale:
   ```bash
   sudo tailscale cert \
     --cert-file $IMMICH_CERTS_DIR/cert.pem \
     --key-file $IMMICH_CERTS_DIR/key.pem \
     $(tailscale status --json | jq -r '.Self.DNSName' | sed 's/\.$//')
   ```
4. todo Is this required? caddy as a user will not exist at this point.
   ```bash
   sudo chown caddy:caddy $IMMICH_CERTS_DIR/cert.pem $IMMICH_CERTS_DIR/key.pem
   ```

> [!NOTE]
> When the certificate expires, run the command in step 3.???

### 3. Create a Certificate Authority (CA)

Create a certificate authority on the immich server that will generate mTLS certificates for trusted devices.

1. Generate a private CA key:
   ```bash
   openssl genrsa -out $IMMICH_CERTS_DIR/ca-key.pem 4096
   ```
2. Generate a self-signed CA certificate:
   ``` bash
   openssl req -new -x509 -days 3650 \
     -key $IMMICH_CERTS_DIR/ca-key.pem \
     -out $IMMICH_CERTS_DIR/ca-cert.pem \
     -subj "/CN=Immich Client CA/O=Personal/C=US"
   ```

### 4. Generate Client Certificates

We need to generate mTLS client certificates for devices that we trust to have full access to our server such as a personal computer or phone. The `expose-immich` nix configuration provides a helpful script to generate these certificates.

```bash
gen-mtls-certs --client-name <client-name> --ca-path $IMMICH_CERTS_DIR
```

This will generate
- **\<client-name\>.crt**: Client certificate
- **\<client-name\>.key**: Client private key
- **\<client-name\>.p12**: PKC12 bundle, required for phones and browsers

### 5. Install mTLS certs on your devices

#### Immich app

1. Transfer the generate `.p12` file to you phone.
2. ...

#### Browser

Assuming a chrome based browser such as brave

1. Add .p12 cert to brave at `brave://certificate-manager/clientcerts`.
2. Add `ca-cert.pem` to `brave://certificate-manager/localcerts/usercerts`.
3. Access your server using the tailscale URL and select the certificate when prompted.

### 6. Open sever to the internet

Now that all the routing and filtering is configured, we can expose our server to the internet. Setup a tailscale funnel to forward raw TCP requests to caddy on port 8443.

```bash
sudo tailscale funnel --bg --tcp 443 tcp://localhost:8443
```

> [!NOTE]
> This command is persistent across reboots. To turn off the tailscale funnel you can use `sudo tailscale funnel reset`
