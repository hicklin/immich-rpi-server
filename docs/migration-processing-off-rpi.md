# Run initial migration processing off the RPi

If there are a lot of files that need to be migrated, the initial CPU intensive processes might cause the RPi to overheat and shutdown. To avoid this, we will spin up an immich server instance on a more powerful machine, such as a laptop/desktop, using the same external hard disk used for the RPi. Media assets are then imported to this local server for processing. Once finished, we will use the external drive in our RPi server setup.

1. Follow [setup step 1](../README.md#1-encrypt-external-drive) to encrypt the external drive.
2. Mount the encrypted drive to your machine.
3. Use `lsblk` to get the mount point path to the drive.
4. Create a `.env` file containing the content below.
   - Change the **DRIVE_PATH** the to mount point path of the external drive.
   - Change the **DB_PASSWORD**.
        > [!CAUTION]
        > Securely store the `DB_PASSWORD`. This is necessary to recover the database which is essential to make sense of our backup.
   ```bash
   # Connection secret for postgres. You should change it to a random password
   # Please use only the characters `A-Za-z0-9`, without special characters or spaces
   DB_PASSWORD=changeThisPassword

   # The path to the root of your external drive
   DRIVE_PATH=/run/media/<user>/immich_drive

   # Do not change the following values
   ###################################################################################

   # The location where your uploaded files are stored
   UPLOAD_LOCATION=${DRIVE_PATH}/immich_data

   # The location where your database files are stored. Network shares are not supported for the database
   DB_DATA_LOCATION=${DRIVE_PATH}/postgres_not_rpi

   # To set a timezone, uncomment the next line and change Etc/UTC to a TZ identifier from this list: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones#List
   # TZ=Etc/UTC

   # The Immich version to use. You can pin this to a specific version like "v2.1.0"
   IMMICH_VERSION=v2

   DB_USERNAME=immich # set to `immich` to match the hardcoded user set in the nix immich service.
   DB_DATABASE_NAME=immich
   ```
   > [!NOTE]
   > It may be possible to use the `UPLOAD_LOCATION` and `DB_DATA_LOCATION` directories generated by your machine on the RPi. However, this is likely to be a smooth transition only if you are creating your immich instance on another NixOs with the same version of immich and postgres.
5. Follow [immich instructions](https://docs.immich.app/install/docker-compose) to setup an immich instance on your machine with the newly created `.env` file.
6. [Migrate your photos and videos](../README.md#migrating-photos).
7. [Create a backup of the database](https://docs.immich.app/administration/backup-and-restore/#trigger-dump).
8. Setup the RPi server
   1. Setup the RPi following [setup step 2](../README.md#2-raspberry-pi-setup).
   2. Setup immich following [setup step 3](../README.md#3-immich-setup) up to and including step 7.
      > [!IMPORTANT]
      > Use the same `DB_PASSWORD` used in step 4 above.
   3. Restore the database following [recovery from cloud storage](../README.md#recovery-from-cloud-storage) steps 7 to 9.
   4. Configure backups following [setup step 4](../README.md#4-configure-backups)
   5. Setup remote access following [setup step 5](../README.md#5-remote-access)
